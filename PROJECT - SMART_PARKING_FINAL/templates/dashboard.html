<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Parking â€” Dashboard (Glassmorphic Dual Theme)</title>

  <!-- Bootstrap (unchanged) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js (unchanged) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    /* ============================
       Glassmorphic + Soft Dual Theme
       Light + Dark modes
       Only visuals changed â€” logic untouched
       ============================ */

    :root{
      /* Common palette */
      --radius-lg: 14px;
      --radius-md: 10px;

      --glass-border-1: rgba(255,255,255,0.28); /* light mode */
      --glass-border-2: rgba(255,255,255,0.06); /* dark mode */

      --accent-cyan: #40E0FF;
      --accent-indigo: #7C6CFF;
      --muted-dark: #6b7788;
      --muted-light: rgba(10,20,40,0.6);

      --smooth-shadow: 0 10px 30px rgba(2,6,23,0.08);
      --lift-shadow: 0 18px 46px rgba(10,25,60,0.12);
    }

    /* ----------------------------
       Base typography & body
       ---------------------------- */
    html, body { height:100%; }
    body {
      margin:0;
      font-family: "Inter", "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background .28s ease, color .18s ease;
      padding-bottom: 48px;
    }

    /* ----------------------------
       LIGHT THEME (glass + airy)
       ---------------------------- */
    body.light {
      --bg: linear-gradient(180deg,#f6f9ff 0%, #f3f7ff 40%, #eef4ff 100%);
      --panel-bg: rgba(255,255,255,0.72);
      --panel-bg-2: rgba(255,255,255,0.60);
      --glass-border: var(--glass-border-1);
      --text-strong: #061226;
      --text-muted: rgba(6,18,38,0.58);
      --card-shadow: 0 10px 30px rgba(12,30,60,0.06);
      --kpi-gloss: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.65));
    }

    /* ----------------------------
       DARK THEME (frosted black)
       ---------------------------- */
    body.dark {
      --bg: radial-gradient(800px 350px at 10% 10%, rgba(62,90,255,0.06), transparent 6%),
             radial-gradient(700px 300px at 90% 90%, rgba(124,108,255,0.03), transparent 6%),
             linear-gradient(180deg,#04050A 0%, #071022 100%);
      --panel-bg: rgba(7,12,20,0.62);
      --panel-bg-2: rgba(8,14,26,0.52);
      --glass-border: var(--glass-border-2);
      --text-strong: #E8F3FF;
      --text-muted: rgba(225,235,255,0.58);
      --card-shadow: 0 12px 36px rgba(3,8,30,0.55);
      --kpi-gloss: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }

    /* initialize with dark if no class */
    body { background: var(--bg); color: var(--text-strong); }

    /* container */
    .container { max-width: 1200px; }

    /* ----------------------------
       NAVBAR
       ---------------------------- */
    .navbar {
      border-radius: 12px;
      padding: 12px 16px;
      margin: 18px auto 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      backdrop-filter: blur(8px) saturate(120%);
      border: 1px solid var(--glass-border);
      background: linear-gradient(180deg, var(--panel-bg), var(--panel-bg-2));
      box-shadow: var(--smooth-shadow);
    }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:700;
      letter-spacing: .2px;
      color: var(--text-strong);
      font-size:1.05rem;
    }
    .brand .logo {
      width:44px;
      height:44px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color: #fff;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-indigo));
      box-shadow: 0 8px 28px rgba(100,80,255,0.12);
    }
    .brand small { font-size:.82rem; color: var(--text-muted); display:block; margin-top:-3px; }

    .nav-actions { display:flex; gap:10px; align-items:center; }

    /* subtle frosted buttons */
    .btn-frost {
      border-radius:10px;
      padding:8px 10px;
      border: 1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color: var(--text-strong);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s;
      box-shadow: 0 6px 18px rgba(2,6,18,0.12);
      font-weight:600;
    }
    .btn-frost:hover { transform: translateY(-4px); box-shadow: var(--lift-shadow); }

    /* logout highlight kept as warning */
    .btn-warning { border-radius:10px; padding:6px 10px; font-weight:700; }

    /* ----------------------------
       FILTER BOX (glass card)
       ---------------------------- */
    .filter-box {
      border-radius: var(--radius-lg);
      padding: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border: 1px solid var(--glass-border);
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(8px) saturate(120%);
      transition: transform .16s ease, box-shadow .16s ease;
    }
    body.dark .filter-box { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .filter-box:hover { transform: translateY(-6px); box-shadow: var(--lift-shadow); }

    .filter-box .form-label { font-size:.88rem; color: var(--text-muted); }
    .filter-box input.form-control, .filter-box select.form-select {
      border-radius:10px;
      padding:10px 12px;
      border: 1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.02);
      color: var(--text-strong);
      transition: box-shadow .12s ease, transform .12s ease;
    }
    .filter-box input::placeholder { color: rgba(200,220,235,0.28); }
    .filter-box input:focus, .filter-box select:focus {
      outline:none;
      box-shadow: 0 8px 28px rgba(0,130,255,0.12);
      transform: translateY(-2px);
      border-color: rgba(0,130,255,0.18);
    }

    .filter-box .btn-success {
      background: linear-gradient(90deg,var(--accent-cyan),var(--accent-indigo));
      border:none;
      border-radius:10px;
      font-weight:700;
      box-shadow: 0 8px 30px rgba(60,120,255,0.08);
    }
    .filter-box .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.03);
      color: var(--text-muted);
      border-radius:10px;
    }

    /* ----------------------------
       KPI CARDS
       ---------------------------- */
    .top-cards .card {
      border-radius: 12px;
      padding: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: var(--card-shadow);
      transition: transform .14s cubic-bezier(.2,.9,.3,1), box-shadow .14s;
    }
    .top-cards .card:hover { transform: translateY(-8px); box-shadow: var(--lift-shadow); }

    .kpi { font-size:1.6rem; font-weight:800; color:var(--text-strong); display:flex; align-items:center; gap:8px; }
    .kpi-sub { color: var(--text-muted); font-size:.92rem; margin-top:6px; display:block; }

    /* revenue styling */
    #kpi_revenue { color: var(--accent-cyan); font-variant-numeric: tabular-nums; }

    /* ----------------------------
       CHART CARDS
       ---------------------------- */
    .chart-card {
      border-radius: 12px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: var(--card-shadow);
      min-height: 220px;
      transition: transform .12s ease;
    }
    .chart-card:hover { transform: translateY(-6px); }
    .chart-card h6 { margin:0 0 8px 0; font-weight:700; color:var(--text-strong); }

    /* ----------------------------
       TABLE â€” glass look, spacious rows
       ---------------------------- */
    .table-responsive {
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      box-shadow: var(--card-shadow);
      margin-top: 12px;
    }

    table.table { margin-bottom:0; color:var(--text-strong); border-collapse: separate; }

    .table thead th {
      background: transparent;
      color: var(--text-muted);
      font-weight:700;
      font-size:.92rem;
      padding: 14px 18px;
      vertical-align: middle;
      letter-spacing: .25px;
      border-bottom: none;
    }

    .table tbody td {
      padding: 16px 18px;
      vertical-align: middle;
      font-size:.95rem;
      color: var(--text-strong);
      border-bottom: 1px solid rgba(255,255,255,0.03);
      background: transparent;
    }

    .table tbody tr {
      transition: transform .12s cubic-bezier(.2,.9,.3,1), box-shadow .12s, background .12s;
      background: linear-gradient(180deg, rgba(255,255,255,0.006), rgba(255,255,255,0.002));
    }

    .table tbody tr:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 48px rgba(2,8,30,0.45);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006));
    }

    /* badges */
    .badge-available, .badge.bg-success {
      background: linear-gradient(90deg,#00F5C3,#00D1B2);
      color: #04212a;
      font-weight:700;
      padding:6px 10px;
      border-radius:10px;
    }
    .badge-occupied, .badge.bg-danger {
      background: linear-gradient(90deg,#FF7B7B,#FF4C4C);
      color:#2b0707;
      font-weight:700;
      padding:6px 10px;
      border-radius:10px;
    }

    /* form controls in table */
    .form-control-sm, .form-select-sm {
      border-radius: 8px;
      padding: 6px 8px;
      height: 36px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.03);
      color: var(--text-strong);
    }

    .btn-primary {
      background: linear-gradient(90deg,var(--accent-cyan), var(--accent-indigo));
      border: none;
      border-radius: 8px;
      padding:8px 12px;
      font-weight:700;
      box-shadow: 0 10px 30px rgba(88,80,255,0.10);
      color: #021025;
    }

    .btn-warning {
      border-radius:8px;
      padding:8px 12px;
      background: linear-gradient(90deg,#FFD166,#FFAE42);
      border:none;
      color:#131313;
      font-weight:700;
    }

    /* pagination */
    .pagination { justify-content:center; padding:14px 0; }
    .pagination .page-item .page-link {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border: 1px solid rgba(255,255,255,0.03);
      color: var(--text-muted);
      margin: 0 6px;
      min-width:44px;
      padding:8px 12px;
      border-radius:10px;
      box-shadow: 0 8px 22px rgba(2,8,30,0.28);
      transition: transform .12s ease;
    }
    .pagination .page-item.active .page-link {
      background: linear-gradient(90deg,var(--accent-cyan),var(--accent-indigo));
      color:#001428;
      border:none;
      box-shadow: 0 14px 36px rgba(90,70,255,0.14);
    }

    /* quick search + rows select */
    #quickSearch {
      border-radius:10px;
      background: rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.03);
      padding:8px 12px;
      color: var(--text-strong);
      width:320px;
    }
    #rowsPerPage {
      border-radius:10px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,0.03);
      background: rgba(255,255,255,0.01);
      color: var(--text-strong);
    }

    /* interactive sort link */
    a.sort { color: var(--text-muted); font-weight:700; text-decoration:none; transition: color .12s, transform .12s; }
    a.sort:hover { color: var(--text-strong); transform: translateY(-3px); }

    /* Payment Modal Styles */
    .modal-content {
      background: var(--panel-bg);
      color: var(--text-strong);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px) saturate(180%);
      border-radius: 15px;
    }
    
    .modal-header {
      border-bottom: 1px solid var(--glass-border);
    }
    
    .modal-footer {
      border-top: 1px solid var(--glass-border);
    }
    
    .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
    }
    
    .payment-option .form-check-input {
      display: none;
    }
    
    .payment-option .payment-card {
      padding: 20px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.02);
      height: 100%;
    }
    
    .payment-option .payment-card:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-5px);
    }
    
    .payment-option .form-check-input:checked + .payment-card {
      border-color: var(--accent-cyan);
      background: rgba(64, 224, 255, 0.1);
      box-shadow: 0 0 25px rgba(64, 224, 255, 0.25);
    }
    
    .payment-card i {
      margin-bottom: 10px;
    }
    
    .payment-card h6 {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .payment-card small {
      color: var(--text-muted);
      font-size: 0.85em;
    }
    
    .qr-placeholder {
      width: 200px;
      height: 200px;
      background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border-radius: 10px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed rgba(255,255,255,0.1);
    }

    /* responsive tweaks */
    @media (max-width: 991px) {
      .container { padding-left:14px; padding-right:14px; }
      .chart-card { min-height: 180px; padding:12px; }
      .payment-card { padding: 15px; }
    }
    @media (max-width: 576px) {
      .controls { flex-direction: column; gap:10px; }
      #quickSearch { width:100%; }
      .brand small { display:none; }
      .payment-option .col-md-6 { margin-bottom: 10px; }
    }

    /* entrance */
    .fade-in { animation: fadeInUp .40s cubic-bezier(.2,.9,.2,1) both; }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(10px);} to { opacity:1; transform: translateY(0);} }

  </style>
</head>

<body class="dark">
  <!-- NAV -->
  <nav class="navbar navbar-dark px-4 py-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <span class="brand">
        <span class="logo">RP</span>
        <span>
          Rathinam Smart Parking â€” Dashboard
          <small style="display:block; font-size:.78rem; color:var(--text-muted); margin-top:3px;">Manage slots â€¢ Bookings â€¢ Revenue</small>
        </span>
      </span>
    </div>

    <div class="d-flex gap-2 align-items-center nav-actions">
      {% if session['role'] == 'admin' %}
        <a href="/history" class="btn-frost btn btn-sm">ðŸ“œ Booking History</a>
      {% endif %}
      <a href="/logout" class="btn-warning btn btn-sm">Logout</a>
      <!-- Theme toggle -->
      <button id="themeToggle" class="btn-frost btn btn-sm" title="Toggle theme">ðŸŒ™</button>
    </div>
  </nav>

  <div class="container mt-4 fade-in">
    <!-- TOP: Filters & Analytics -->
    <div class="row g-3 align-items-start">
      <!-- Filters -->
      <div class="col-lg-4">
        <form method="get" action="/dashboard" class="filter-box">
          <div class="row g-2 filter-grid">
            <div class="col-12 mb-1 d-flex justify-content-between align-items-center">
              <strong style="font-size:1.02rem;">Filters</strong>
              <small class="muted-small" style="color:var(--text-muted);">Refine view</small>
            </div>

            <div class="col-12">
              <label class="form-label mb-1 small text-muted">Vehicle number</label>
              <input class="form-control" name="vehicle_search" placeholder="Enter vehicle number"
                     value="{{ request.args.get('vehicle_search','') }}">
            </div>

            <div class="col-12">
              <label class="form-label mb-1 small text-muted">Zone</label>
              <select class="form-select" name="zone_filter">
                <option value="">All Zones</option>
                {% for z in zones %}
                  <option value="{{ z.area_name }}"
                    {% if request.args.get('zone_filter')==z.area_name %} selected {% endif %}>
                    {{ z.area_name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-6">
              <button class="btn btn-success w-100">Apply Filters</button>
            </div>
            <div class="col-6">
              <a href="/dashboard" class="btn btn-secondary w-100">Clear</a>
            </div>

            <div class="col-12 mt-2">
              <small class="text-muted" style="color:var(--text-muted);">Tip: You can sort the table by clicking column headers and use quick search.</small>
            </div>
          </div>
        </form>
      </div>

      <!-- Analytics -->
      <div class="col-lg-8">
        <div class="row top-cards gx-3">
          <div class="col-md-3 col-sm-6">
            <div class="card p-3">
              <div class="kpi" id="kpi_total">â€”</div>
              <div class="kpi-sub">Total Slots</div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6">
            <div class="card p-3">
              <div class="kpi text-success" id="kpi_available">â€”</div>
              <div class="kpi-sub">Available</div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6">
            <div class="card p-3">
              <div class="kpi text-danger" id="kpi_occupied">â€”</div>
              <div class="kpi-sub">Occupied</div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6">
            <div class="card p-3">
              <div class="kpi" id="kpi_revenue">â‚¹ â€”</div>
              <div class="kpi-sub">Total Revenue</div>
            </div>
          </div>

          <!-- Charts -->
          <div class="col-12 mt-3">
            <div class="row g-3">
              <div class="col-md-5">
                <div class="chart-card">
                  <h6 class="mb-2">Slot Status Distribution</h6>
                  <canvas id="statusPie" height="220"></canvas>
                </div>
              </div>
              <div class="col-md-7">
                <div class="chart-card">
                  <h6 class="mb-2">Parking Fees by Zone (est.)</h6>
                  <canvas id="feeBar" height="220"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div><!-- end analytics -->
      </div>
    </div>

    <!-- TABLE + Controls -->
   <div class="row mt-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-2 controls">
          <div>
            <label class="me-2"><strong>Show</strong></label>
            <select id="rowsPerPage" class="form-select d-inline-block" style="width: auto;">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="25">25</option>
            </select>
          </div>

          <div style="width:320px;">
            <input id="quickSearch" class="form-control form-control-sm" placeholder="Quick search (client-side)">
          </div>
        </div>

        <div class="table-responsive shadow-sm">
          <table class="table table-hover table-bordered align-middle" id="slotTable">
            <thead class="table-light">
              <tr>
                <th><a href="#" class="sort" data-key="slot_number">Slot No â†•</a></th>
                <th><a href="#" class="sort" data-key="area_name">Zone â†•</a></th>
                <th><a href="#" class="sort" data-key="slot_type">Type â†•</a></th>
                <th><a href="#" class="sort" data-key="status">Status â†•</a></th>
                <th>Vehicle No</th>
                <th>Vehicle Type</th>
                <th><a href="#" class="sort" data-key="booking_time">Booking Time â†•</a></th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="slotTbody">
              <!-- rows are generated by JS from slotsJson -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <nav>
          <ul class="pagination mt-3" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Payment Modal (ADDED HERE) -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Checkout Vehicle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="checkoutForm" method="post" action="/checkout_slot">
            <input type="hidden" name="slot_id" id="modalSlotId">
            
            <div class="mb-4">
              <label class="form-label mb-3"><i class="fas fa-credit-card me-2"></i>Select Payment Method</label>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-check payment-option">
                    <input class="form-check-input" type="radio" name="payment_method" id="cashPayment" value="cash" checked>
                    <label class="form-check-label w-100" for="cashPayment">
                      <div class="payment-card">
                        <i class="fas fa-money-bill-wave fa-2x mb-3 text-success"></i>
                        <h6>Cash Payment</h6>
                        <small>Pay with cash at counter</small>
                      </div>
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check payment-option">
                    <input class="form-check-input" type="radio" name="payment_method" id="qrPayment" value="qr">
                    <label class="form-check-label w-100" for="qrPayment">
                      <div class="payment-card">
                        <i class="fas fa-qrcode fa-2x mb-3 text-primary"></i>
                        <h6>QR Code Payment</h6>
                        <small>Scan QR to pay via UPI</small>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="qrPreview" class="text-center mb-3" style="display: none;">
              <p class="small text-muted mb-2">QR code will be generated after checkout</p>
              <div class="qr-placeholder">
                <i class="fas fa-qrcode fa-3x text-muted"></i>
              </div>
              <p class="mt-2 small text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Scan with any UPI app (GPay, PhonePe, Paytm)
              </p>
            </div>
            
            <div class="alert alert-info" style="background: rgba(64, 224, 255, 0.1); border: 1px solid rgba(64, 224, 255, 0.2);">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Note:</strong> The exact parking fee will be calculated at checkout based on vehicle type and duration.
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="checkoutForm" class="btn btn-success">
            <i class="fas fa-check-circle me-2"></i>Proceed to Checkout
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       JavaScript (logic preserved)
       ========================= -->
  <script>
  document.addEventListener('DOMContentLoaded', function(){

    /* ---------- Data passed from Flask ---------- */
    const slots = (function(){ try { return {{ slots|tojson | safe }} || []; } catch(e){ return []; } })();

    /* user's role safely passed */
    const userRole = "{{ session.get('role','') }}";

    /* ---------- Utility functions ---------- */
    function safeNum(v){ return (v===null||v===undefined||v==="")?0: Number(v); }

    /* ---------- Analytics (populate cards + charts) ---------- */
    function computeAnalytics(slotsList){
      const total = slotsList.length;
      const occupied = slotsList.filter(s => s.status && s.status.toLowerCase()==='occupied').length;
      const available = total - occupied;
      const revenue = slotsList.reduce((sum,s)=> sum + safeNum(s.parking_fee), 0);

      const el = id => document.getElementById(id);
      if(el('kpi_total')) el('kpi_total').textContent = total;
      if(el('kpi_available')) el('kpi_available').textContent = available;
      if(el('kpi_occupied')) el('kpi_occupied').textContent = occupied;
      if(el('kpi_revenue')) el('kpi_revenue').textContent = 'â‚¹ ' + revenue;

      // status pie
      const ctxPieEl = document.getElementById('statusPie');
      if(ctxPieEl){
        const ctxPie = ctxPieEl.getContext('2d');
        if(window.pieChart) window.pieChart.destroy();
        window.pieChart = new Chart(ctxPie, {
          type: 'pie',
          data: {
            labels: ['Available','Occupied'],
            datasets: [{ data: [available, occupied], backgroundColor: ['#00F5C3','#FF7B7B'] }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      }

      // fees by zone
      const feesByZone = {};
      slotsList.forEach(s=>{
        const zone = s.area_name || 'Unknown';
        feesByZone[zone] = (feesByZone[zone] || 0) + safeNum(s.parking_fee);
      });
      const labels = Object.keys(feesByZone);
      const data = labels.map(z=>feesByZone[z]);

      const ctxBarEl = document.getElementById('feeBar');
      if(ctxBarEl){
        const ctxBar = ctxBarEl.getContext('2d');
        if(window.barChart) window.barChart.destroy();
        window.barChart = new Chart(ctxBar, {
          type: 'bar',
          data: { labels: labels, datasets: [{ label: 'Revenue (â‚¹)', data: data }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }
    }

    /* ---------- Client-side table rendering, sorting, pagination ---------- */
    let currentPage = 1;
    let rowsPerPage = 10;
    let currentSort = { key: null, dir: 1 };
    let filtered = [...slots];

    const tbody = document.getElementById('slotTbody');
    const pagination = document.getElementById('pagination');

    function renderTable(){
      if(!tbody) return;
      tbody.innerHTML = '';
      rowsPerPage = Number((document.getElementById('rowsPerPage') || {value:10}).value || 10);

      let data = [...filtered];
      if(currentSort.key){
        data.sort((a,b)=>{
          let va = (a[currentSort.key]===null||a[currentSort.key]===undefined)?'' : a[currentSort.key];
          let vb = (b[currentSort.key]===null||b[currentSort.key]===undefined)?'' : b[currentSort.key];
          if(currentSort.key==='parking_fee') return currentSort.dir * (safeNum(va) - safeNum(vb));
          if(currentSort.key==='booking_time') return currentSort.dir * ((va? new Date(va).getTime():0) - (vb? new Date(vb).getTime():0));
          return currentSort.dir * String(va).localeCompare(String(vb));
        });
      }

      const totalPages = Math.max(1, Math.ceil(data.length / rowsPerPage));
      if(currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage-1)*rowsPerPage;
      const pageItems = data.slice(start, start + rowsPerPage);

      pageItems.forEach(s => {
        const tr = document.createElement('tr');
        
        // Determine actions based on status and role
        let actions = '';
        if (s.status && s.status.toLowerCase() === 'available') {
          actions = `<form method="post" action="/book_slot" class="d-flex gap-1 align-items-center" style="gap:.35rem">
                      <input type="hidden" name="slot_id" value="${s.slot_id}">
                      <input type="text" name="vehicle_number" class="form-control form-control-sm" placeholder="Vehicle No" required>
                      <select name="vehicle_type" class="form-select form-select-sm" required>
                        <option value="Car">Car</option>
                        <option value="SUV">SUV</option>
                        <option value="Truck">Truck</option>
                        <option value="Bike">Bike</option>
                        <option value="Scooter">Scooter</option>
                      </select>
                      <button class="btn btn-primary btn-sm">Book</button>
                    </form>`;
        } else if (userRole === 'admin') {
          // Changed to use modal instead of direct form
          actions = `<button class="btn btn-warning btn-sm" onclick="showCheckoutModal('${s.slot_id}')">Checkout</button>`;
        } else {
          actions = `<span class="text-secondary">Not Allowed</span>`;
        }
        
        tr.innerHTML = `
          <td><strong>${s.slot_number || ''}</strong></td>
          <td>${s.area_name || '-'}</td>
          <td>${s.slot_type || '-'}</td>
          <td>${s.status && s.status.toLowerCase() === 'available'
            ? '<span class="badge bg-success">Available</span>'
            : '<span class="badge bg-danger">Occupied</span>'}
          </td>
          <td>${s.vehicle_number || '-'}</td>
          <td>${s.vehicle_type || '-'}</td>
          <td>${s.booking_time ? (new Date(s.booking_time)).toLocaleString() : '-'}</td>
          <td>${actions}</td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(totalPages);
    }

    function renderPagination(totalPages){
      if(!pagination) return;
      pagination.innerHTML = '';
      const createPageItem = (p, label = null, active=false, disabled=false) => {
        const li = document.createElement('li');
        li.className = 'page-item' + (active? ' active':'') + (disabled? ' disabled':'');
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = label||p;
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          if(disabled) return;
          if(p === 'prev') currentPage = Math.max(1, currentPage-1);
          else if(p === 'next') currentPage = Math.min(totalPages, currentPage+1);
          else currentPage = p;
          renderTable();
        });
        li.appendChild(a);
        return li;
      };

      pagination.appendChild(createPageItem('prev','Prev', false, currentPage===1));
      const maxButtons = 7;
      let start = Math.max(1, currentPage - Math.floor(maxButtons/2));
      let end = Math.min(totalPages, start + maxButtons - 1);
      if(end - start < maxButtons - 1) start = Math.max(1, end - maxButtons + 1);
      for(let i=start;i<=end;i++){
        pagination.appendChild(createPageItem(i, i, i===currentPage));
      }
      pagination.appendChild(createPageItem('next','Next', false, currentPage===totalPages));
    }

    /* ---------- Sorting handlers ---------- */
    document.querySelectorAll('.sort').forEach(el=>{
      el.addEventListener('click', (e)=>{
        e.preventDefault();
        const k = el.getAttribute('data-key');
        if(currentSort.key === k) currentSort.dir *= -1; else { currentSort.key = k; currentSort.dir = 1; }
        renderTable();
      });
    });

    /* ---------- rows per page change ---------- */
    const rowsSel = document.getElementById('rowsPerPage');
    if(rowsSel){
      rowsSel.addEventListener('change', ()=>{
        currentPage = 1;
        renderTable();
      });
    }

    /* ---------- quick client-side search ---------- */
    const quickSearchEl = document.getElementById('quickSearch');
    if(quickSearchEl){
      quickSearchEl.addEventListener('input', (e)=>{
        const q = e.target.value.trim().toLowerCase();
        if(!q) filtered = [...slots];
        else filtered = slots.filter(s =>
          (s.slot_number||'').toString().toLowerCase().includes(q) ||
          (s.vehicle_number||'').toString().toLowerCase().includes(q) ||
          (s.area_name||'').toString().toLowerCase().includes(q)
        );
        currentPage = 1;
        renderTable();
      });
    }

    /* ---------- initial filtered by server (server already filtered) ---------- */
    filtered = [...slots];

    /* ---------- initialize analytics & table ---------- */
    computeAnalytics(slots);
    renderTable();

    /* ---------- theme toggle (persist in localStorage) ---------- */
    const tbtn = document.getElementById('themeToggle');
    function setTheme(useDark){
      if(useDark){
        document.body.classList.remove('light');
        document.body.classList.add('dark');
        localStorage.setItem('parking_theme', 'dark');
        if(tbtn) tbtn.textContent = 'â˜€ï¸';
      } else {
        document.body.classList.remove('dark');
        document.body.classList.add('light');
        localStorage.setItem('parking_theme', 'light');
        if(tbtn) tbtn.textContent = 'ðŸŒ™';
      }
    }
    if(tbtn){
      tbtn.addEventListener('click', ()=> setTheme(document.body.classList.contains('light')));
    }
    // initialize theme from storage (default: dark)
    const savedTheme = localStorage.getItem('parking_theme');
    if(savedTheme === 'light') setTheme(false); else setTheme(true);

  }); // DOMContentLoaded

  /* ---------- Checkout Modal Functions (ADDED HERE) ---------- */
  function showCheckoutModal(slotId) {
    // Set the slot ID in the hidden input
    document.getElementById('modalSlotId').value = slotId;
    
    // Get references to elements
    const qrPaymentRadio = document.getElementById('qrPayment');
    const cashPaymentRadio = document.getElementById('cashPayment');
    const qrPreview = document.getElementById('qrPreview');
    
    // Show/hide QR preview based on payment method
    function toggleQRPreview() {
      if (qrPaymentRadio.checked) {
        qrPreview.style.display = 'block';
      } else {
        qrPreview.style.display = 'none';
      }
    }
    
    // Add event listeners for payment method changes
    qrPaymentRadio.addEventListener('change', toggleQRPreview);
    cashPaymentRadio.addEventListener('change', toggleQRPreview);
    
    // Initialize QR preview state
    toggleQRPreview();
    
    // Show the modal
    const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
    checkoutModal.show();
  }
  </script>

  <!-- Bootstrap JS Bundle (needed for modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>