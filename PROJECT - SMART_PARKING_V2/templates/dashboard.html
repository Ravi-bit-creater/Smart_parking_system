<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Smart Parking â€” Dashboard</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root{
            --bg-light: #f2f6ff;
            --card-bg: #ffffff;
            --muted: #6c757d;
            --accent: #0077ff;
            --success: #198754;
            --danger: #dc3545;
        }

        body { background: var(--bg-light); font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

        /* Dark mode */
        body.dark {
            --bg-light: #0f1720;
            --card-bg: #0b1220;
            --muted: #98a0ad;
            --accent: #66a6ff;
            color: #e6eefc;
        }

        .navbar {
            background: linear-gradient(90deg,#004aad,#0077ff);
            color: white;
        }

        .navbar .brand { font-weight: 700; font-size: 1.15rem; }

        .top-cards .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(20,35,75,0.06); }
        .card .kpi { font-size: 1.65rem; font-weight: 700; }
        .card .kpi-sub { color: var(--muted); font-size: .95rem; }

        .chart-card { padding: 18px; border-radius: 12px; background: var(--card-bg); box-shadow: 0 6px 18px rgba(20,35,75,0.05); }
        .filter-box { border-left: 4px solid var(--accent); border-radius: 8px; background: var(--card-bg); padding: 14px; box-shadow: 0 6px 16px rgba(20,35,75,0.04); }

        table tbody tr:hover { background: rgba(2,6,23,0.03); transform: translateY(-2px); transition: .12s; }
        .badge-available { background:#198754; }
        .badge-occupied  { background:#dc3545; }

        /* Pagination UI */
        .pagination { justify-content: center; }

        /* small screens */
        @media (max-width: 768px) {
            .top-cards .col-md-3 { margin-bottom: 12px; }
            .filter-grid { gap: 8px; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark px-4 py-2 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
        <span class="brand text-white">ðŸš— Rathinam Smart Parking â€” Dashboard</span>
    </div>

    <div class="d-flex gap-2 align-items-center">
        {% if session['role'] == 'admin' %}
            <a href="/history" class="btn btn-light btn-sm">ðŸ“œ Booking History</a>
        {% endif %}
        <a href="/logout" class="btn btn-danger btn-sm">Logout</a>

        <!-- Theme toggle -->
        <button id="themeToggle" class="btn btn-outline-light btn-sm" title="Toggle theme">ðŸŒ™</button>
    </div>
</nav>

<div class="container mt-4">

    <!-- TOP: Filters & Analytics -->
    <div class="row g-3 align-items-start">
        <!-- Filters -->
        <div class="col-lg-4">
            <form method="get" action="/dashboard" class="filter-box">
                <div class="row g-2 filter-grid">
                    <div class="col-12 mb-1"><strong>Filters</strong></div>

                    <div class="col-12">
                        <label class="form-label mb-1 small text-muted">Vehicle number</label>
                        <input class="form-control" name="vehicle_search" placeholder="Enter vehicle number"
                               value="{{ request.args.get('vehicle_search','') }}">
                    </div>

                    <div class="col-12">
                        <label class="form-label mb-1 small text-muted">Zone</label>
                        <select class="form-select" name="zone_filter">
                            <option value="">All Zones</option>
                            {% for z in zones %}
                                <option value="{{ z.area_name }}"
                                    {% if request.args.get('zone_filter')==z.area_name %} selected {% endif %}>
                                    {{ z.area_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-6">
                        <button class="btn btn-success w-100">Apply Filters</button>
                    </div>
                    <div class="col-6">
                        <a href="/dashboard" class="btn btn-secondary w-100">Clear</a>
                    </div>

                    <div class="col-12 mt-2">
                        <small class="text-muted">Tip: You can also sort and paginate the table below.</small>
                    </div>
                </div>
            </form>
        </div>

        <!-- Analytics -->
        <div class="col-lg-8">
            <div class="row top-cards gx-3">
                <div class="col-md-3">
                    <div class="card p-3">
                        <div class="kpi" id="kpi_total">â€”</div>
                        <div class="kpi-sub">Total Slots</div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card p-3">
                        <div class="kpi text-success" id="kpi_available">â€”</div>
                        <div class="kpi-sub">Available</div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card p-3">
                        <div class="kpi text-danger" id="kpi_occupied">â€”</div>
                        <div class="kpi-sub">Occupied</div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card p-3">
                        <div class="kpi" id="kpi_revenue">â‚¹ â€”</div>
                        <div class="kpi-sub">Today's Revenue (est.)</div>
                    </div>
                </div>

                <!-- Charts row -->
                <div class="col-12 mt-3">
                    <div class="row g-3">
                        <div class="col-md-5">
                            <div class="chart-card">
                                <h6 class="mb-2">Slot Status Distribution</h6>
                                <canvas id="statusPie" height="220"></canvas>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="chart-card">
                                <h6 class="mb-2">Parking Fees by Zone (est.)</h6>
                                <canvas id="feeBar" height="220"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- end analytics -->
        </div>
    </div>

    <!-- TABLE + Controls -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <label class="me-2"><strong>Show</strong></label>
                    <select id="rowsPerPage" class="form-select d-inline-block" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                    </select>
                </div>

                <div>
                    <input id="quickSearch" class="form-control form-control-sm" placeholder="Quick search (client-side)">
                </div>
            </div>

            <div class="table-responsive shadow-sm">
                <table class="table table-hover table-bordered align-middle" id="slotTable">
                    <thead class="table-light">
                        <tr>
                            <th><a href="#" class="sort" data-key="slot_number">Slot No â†•</a></th>
                            <th><a href="#" class="sort" data-key="area_name">Zone â†•</a></th>
                            <th><a href="#" class="sort" data-key="slot_type">Type â†•</a></th>
                            <th><a href="#" class="sort" data-key="status">Status â†•</a></th>
                            <th>Vehicle No</th>
                            <th>Vehicle Type</th>
                            <th><a href="#" class="sort" data-key="booking_time">Booking Time â†•</a></th>
                            <th><a href="#" class="sort" data-key="parking_fee">Fee â†•</a></th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="slotTbody">
                        <!-- rows are generated by JS from slotsJson -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav>
                <ul class="pagination mt-3" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){

    /* ---------- Data passed from Flask ---------- */
    const slots = (function(){ try { return {{ slots|tojson | safe }} || []; } catch(e){ return []; } })();

    /* user's role safely passed */
    const userRole = "{{ session.get('role','') }}";

    /* ---------- Utility functions ---------- */
    function safeNum(v){ return (v===null||v===undefined||v==="")?0: Number(v); }

    /* ---------- Analytics (populate cards + charts) ---------- */
    function computeAnalytics(slotsList){
        const total = slotsList.length;
        const occupied = slotsList.filter(s => s.status && s.status.toLowerCase()==='occupied').length;
        const available = total - occupied;
        const revenue = slotsList.reduce((sum,s)=> sum + safeNum(s.parking_fee), 0);

        const el = id => document.getElementById(id);
        if(el('kpi_total')) el('kpi_total').textContent = total;
        if(el('kpi_available')) el('kpi_available').textContent = available;
        if(el('kpi_occupied')) el('kpi_occupied').textContent = occupied;
        if(el('kpi_revenue')) el('kpi_revenue').textContent = 'â‚¹ ' + revenue;

        // status pie
        const ctxPieEl = document.getElementById('statusPie');
        if(ctxPieEl){
            const ctxPie = ctxPieEl.getContext('2d');
            if(window.pieChart) window.pieChart.destroy();
            window.pieChart = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: ['Available','Occupied'],
                    datasets: [{ data: [available, occupied], backgroundColor: ['#198754','#dc3545'] }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        // fees by zone
        const feesByZone = {};
        slotsList.forEach(s=>{
            const zone = s.area_name || 'Unknown';
            feesByZone[zone] = (feesByZone[zone] || 0) + safeNum(s.parking_fee);
        });
        const labels = Object.keys(feesByZone);
        const data = labels.map(z=>feesByZone[z]);

        const ctxBarEl = document.getElementById('feeBar');
        if(ctxBarEl){
            const ctxBar = ctxBarEl.getContext('2d');
            if(window.barChart) window.barChart.destroy();
            window.barChart = new Chart(ctxBar, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Revenue (â‚¹)', data: data }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
    }

    /* ---------- Client-side table rendering, sorting, pagination ---------- */
    let currentPage = 1;
    let rowsPerPage = 10;
    let currentSort = { key: null, dir: 1 };
    let filtered = [...slots];

    const tbody = document.getElementById('slotTbody');
    const pagination = document.getElementById('pagination');

    function renderTable(){
        if(!tbody) return;
        tbody.innerHTML = '';
        rowsPerPage = Number((document.getElementById('rowsPerPage') || {value:10}).value || 10);

        let data = [...filtered];
        if(currentSort.key){
            data.sort((a,b)=>{
                let va = (a[currentSort.key]===null||a[currentSort.key]===undefined)?'' : a[currentSort.key];
                let vb = (b[currentSort.key]===null||b[currentSort.key]===undefined)?'' : b[currentSort.key];
                if(currentSort.key==='parking_fee') return currentSort.dir * (safeNum(va) - safeNum(vb));
                if(currentSort.key==='booking_time') return currentSort.dir * ((va? new Date(va).getTime():0) - (vb? new Date(vb).getTime():0));
                return currentSort.dir * String(va).localeCompare(String(vb));
            });
        }

        const totalPages = Math.max(1, Math.ceil(data.length / rowsPerPage));
        if(currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage-1)*rowsPerPage;
        const pageItems = data.slice(start, start + rowsPerPage);

        pageItems.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${s.slot_number || ''}</strong></td>
                <td>${s.area_name || '-'}</td>
                <td>${s.slot_type || '-'}</td>
                <td>${s.status && s.status.toLowerCase() === 'available'
                    ? '<span class="badge bg-success">Available</span>'
                    : '<span class="badge bg-danger">Occupied</span>'}
                </td>
                <td>${s.vehicle_number || '-'}</td>
                <td>${s.vehicle_type || '-'}</td>
                <td>${s.booking_time ? (new Date(s.booking_time)).toLocaleString() : '-'}</td>
                <td>${s.parking_fee!==null && s.parking_fee!==undefined && s.parking_fee!=='' ? 'â‚¹ ' + s.parking_fee : '-'}</td>
                <td>
                ${ s.status && s.status.toLowerCase()==='available' 
                    ? `<form method="post" action="/book_slot" class="d-flex gap-1 align-items-center" style="gap:.35rem">
                            <input type="hidden" name="slot_id" value="${s.slot_id}">
                            <input type="text" name="vehicle_number" class="form-control form-control-sm" placeholder="Vehicle No" required>
                            <select name="vehicle_type" class="form-select form-select-sm" required>
                                <option value="Two Wheeler">Two Wheeler</option>
                                <option value="Four Wheeler">Four Wheeler</option>
                            </select>
                            <button class="btn btn-primary btn-sm">Book</button>
                       </form>`
                    : ( userRole === 'admin'
                        ? `<form method="post" action="/checkout_slot">
                            <input type="hidden" name="slot_id" value="${s.slot_id}">
                            <button class="btn btn-warning btn-sm">Checkout</button>
                           </form>`
                        : `<span class="text-secondary">Not Allowed</span>`
                      )
                }
                </td>
            `;
            tbody.appendChild(tr);
        });

        renderPagination(totalPages);
    }

    function renderPagination(totalPages){
        if(!pagination) return;
        pagination.innerHTML = '';
        const createPageItem = (p, label = null, active=false, disabled=false) => {
            const li = document.createElement('li');
            li.className = 'page-item' + (active? ' active':'') + (disabled? ' disabled':'');
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = label||p;
            a.addEventListener('click', (e)=>{
                e.preventDefault();
                if(disabled) return;
                if(p === 'prev') currentPage = Math.max(1, currentPage-1);
                else if(p === 'next') currentPage = Math.min(totalPages, currentPage+1);
                else currentPage = p;
                renderTable();
            });
            li.appendChild(a);
            return li;
        };

        pagination.appendChild(createPageItem('prev','Prev', false, currentPage===1));
        const maxButtons = 7;
        let start = Math.max(1, currentPage - Math.floor(maxButtons/2));
        let end = Math.min(totalPages, start + maxButtons - 1);
        if(end - start < maxButtons - 1) start = Math.max(1, end - maxButtons + 1);
        for(let i=start;i<=end;i++){
            pagination.appendChild(createPageItem(i, i, i===currentPage));
        }
        pagination.appendChild(createPageItem('next','Next', false, currentPage===totalPages));
    }

    /* ---------- Sorting handlers ---------- */
    document.querySelectorAll('.sort').forEach(el=>{
        el.addEventListener('click', (e)=>{
            e.preventDefault();
            const k = el.getAttribute('data-key');
            if(currentSort.key === k) currentSort.dir *= -1; else { currentSort.key = k; currentSort.dir = 1; }
            renderTable();
        });
    });

    /* ---------- rows per page change ---------- */
    const rowsSel = document.getElementById('rowsPerPage');
    if(rowsSel){
        rowsSel.addEventListener('change', ()=>{
            currentPage = 1;
            renderTable();
        });
    }

    /* ---------- quick client-side search ---------- */
    const quickSearchEl = document.getElementById('quickSearch');
    if(quickSearchEl){
        quickSearchEl.addEventListener('input', (e)=>{
            const q = e.target.value.trim().toLowerCase();
            if(!q) filtered = [...slots];
            else filtered = slots.filter(s =>
                (s.slot_number||'').toString().toLowerCase().includes(q) ||
                (s.vehicle_number||'').toString().toLowerCase().includes(q) ||
                (s.area_name||'').toString().toLowerCase().includes(q)
            );
            currentPage = 1;
            renderTable();
        });
    }

    /* ---------- initial filtered by server (server already filtered) ---------- */
    filtered = [...slots];

    /* ---------- initialize analytics & table ---------- */
    computeAnalytics(slots);
    renderTable();

    /* ---------- theme toggle (persist in localStorage) ---------- */
    const tbtn = document.getElementById('themeToggle');
    function setTheme(dark){
        if(dark) document.body.classList.add('dark'); else document.body.classList.remove('dark');
        localStorage.setItem('parking_dark', dark ? '1' : '0');
        if(tbtn) tbtn.textContent = dark ? 'â˜€ï¸' : 'ðŸŒ™';
    }
    if(tbtn){
        tbtn.addEventListener('click', ()=> setTheme(!document.body.classList.contains('dark')));
    }
    setTheme(localStorage.getItem('parking_dark') === '1');

}); // DOMContentLoaded
</script>

</body>
</html>
