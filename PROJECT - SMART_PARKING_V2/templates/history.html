<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Booking History | Rathinam Smart Parking</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        :root{
            --bg: #f3f6ff;
            --card: #ffffff;
            --text: #1b2430;
        }
        body.dark{
            --bg: #0d1623;
            --card: #0b1220;
            --text: #e8eef9;
        }

        body{
            background: var(--bg);
            color: var(--text);
            font-family: "Poppins", sans-serif;
        }
        .table-container{
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }
        .table tbody tr:hover{
            background: rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .badge-success{ background:#198754; }
        .badge-danger{ background:#dc3545; }
        .sortable{ cursor:pointer; text-decoration: underline; }
        .navbar-custom{
            background: linear-gradient(90deg,#004aad,#0077ff);
        }
        #themeToggle{
            border: none;
            background: none;
            font-size: 22px;
            cursor: pointer;
            color: white;
        }
    </style>
</head>

<body>

<nav class="navbar navbar-dark navbar-custom px-4 py-2 d-flex justify-content-between">
    <h4 class="text-white m-0">üìú Booking History</h4>
    <div class="d-flex gap-2">
        <a href="/dashboard" class="btn btn-light btn-sm">üè† Dashboard</a>
        <button id="themeToggle">üåô</button>
    </div>
</nav>

<div class="container mt-4">

    <div class="d-flex justify-content-between mb-3 align-items-center">
        <input id="searchBox" class="form-control w-50" placeholder="üîç Search by vehicle / slot / status (client side)">
        <select id="rowsPerPage" class="form-select w-auto">
            <option value="5">5 rows</option>
            <option value="10" selected>10 rows</option>
            <option value="25">25 rows</option>
        </select>
    </div>

    <div class="table-container">
        <table class="table table-hover table-bordered align-middle" id="historyTable">
            <thead class="table-dark">
                <tr>
                    <th class="sortable" data-key="booking_id">Booking ID</th>
                    <th class="sortable" data-key="slot_number">Slot Number</th>
                    <th>Area ID</th>
                    <th>User ID</th>
                    <th class="sortable" data-key="booking_date">Booking Date</th>
                    <th class="sortable" data-key="in_time">In Time</th>
                    <th class="sortable" data-key="out_time">Out Time</th>
                    <th class="sortable" data-key="status">Status</th>
                </tr>
            </thead>
            <tbody id="historyBody">
                {% for row in history %}
                <tr>
                    <td>{{ row.booking_id }}</td>
                    <td>{{ row.slot_number }}</td>
                    <td>{{ row.area_id }}</td>
                    <td>{{ row.user_id }}</td>
                    <td>{{ row.booking_date }}</td>
                    <td>{{ row.in_time }}</td>
                    <td>{{ row.out_time if row.out_time else '-' }}</td>
                    <td>
                        {% if row.status == "occupied" %}
                            <span class="badge bg-danger">Occupied</span>
                        {% else %}
                            <span class="badge bg-success">Checked Out</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <nav>
            <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
        </nav>
    </div>

</div>

<script>
const tableRows = Array.from(document.querySelectorAll("#historyBody tr"));
let filtered = [...tableRows];
let currentPage = 1;
let rowsPerPage = 10;
let sortKey = null, sortDir = 1;

function renderTable(){
    rowsPerPage = Number(document.getElementById("rowsPerPage").value);
    const totalPages = Math.ceil(filtered.length / rowsPerPage);
    if(currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage-1)*rowsPerPage;
    const visible = filtered.slice(start, start+rowsPerPage);

    const body = document.getElementById("historyBody");
    body.innerHTML = "";
    visible.forEach(r => body.appendChild(r));

    renderPagination(totalPages);
}

function renderPagination(total){
    const pag = document.getElementById("pagination");
    pag.innerHTML = "";

    for(let p=1; p<=total; p++){
        const li = document.createElement("li");
        li.className = `page-item ${p===currentPage ? 'active' : ''}`;
        li.innerHTML = `<a href="#" class="page-link">${p}</a>`;
        li.addEventListener("click", e=>{
            e.preventDefault();
            currentPage = p;
            renderTable();
        });
        pag.appendChild(li);
    }
}

document.getElementById("searchBox").addEventListener("input", e=>{
    const q = e.target.value.toLowerCase();
    filtered = tableRows.filter(r => r.innerText.toLowerCase().includes(q));
    currentPage = 1;
    renderTable();
});

document.querySelectorAll(".sortable").forEach(th=>{
    th.addEventListener("click", ()=>{
        const index = [...th.parentNode.children].indexOf(th);
        sortDir = sortKey === index ? -sortDir : 1;
        sortKey = index;
        filtered.sort((a,b)=> sortDir * a.children[index].innerText.localeCompare(b.children[index].innerText));
        renderTable();
    });
});

document.getElementById("rowsPerPage").addEventListener("change", ()=>{
    currentPage = 1;
    renderTable();
});

renderTable();

/* Dark mode */
const btn = document.getElementById("themeToggle");
function setTheme(dark){
    document.body.classList.toggle("dark", dark);
    btn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("hist_dark", dark ? "1" : "0");
}
btn.addEventListener("click", ()=> setTheme(!document.body.classList.contains("dark")));
setTheme(localStorage.getItem("hist_dark") === "1");
</script>

</body>
</html>
